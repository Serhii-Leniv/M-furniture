<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <title>M-фурнітура</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link th:href="@{/css/main.css}" rel="stylesheet">
  <style>
    .main-category-box {
      padding: 10px 15px;
      border: 1px solid #000080;
      border-radius: 10px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #000080;
      width: 90%;
      max-width: 180px; /* Трохи збільшимо максимальну ширину для основних категорій */
      color: white; /* Білий колір тексту для основних категорій */
      text-align: center;
      display: inline-block; /* Щоб розміщувати в один ряд */
    }

    .main-category-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .main-category-box.active {
      border-color: #000080;
      background-color: #ADD8E6; /* Світліший фон для активної основної категорії */
      color: #000080;
    }

    .subcategory-box {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      width: 90%;
      max-width: 150px;
      color: #000080;
      text-align: center;
      display: inline-block; /* Щоб розміщувати в один ряд */
    }

    .subcategory-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* Для покращення використання простору на екранах */
    .product-item .card {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .product-item .card img {
      max-height: 200px; /* Обмежуємо висоту зображення */
      object-fit: cover; /* Покращуємо відображення зображення */
      width: 100%; /* Ширина на 100% */
    }

    /* Збільшуємо простір для карток на екранах */
    .products-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 15px;
    }

    .product-item {
      flex: 0 0 22%; /* Залишаємо 4 картки в ряд */
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      .product-item {
        flex: 0 0 48%; /* 2 картки в ряд на середніх екранах */
      }
    }

    @media (max-width: 480px) {
      .product-item {
        flex: 0 0 100%; /* 1 картка на маленьких екранах */
      }
    }

    /* Приховуємо елементи за замовчуванням */
    #subcategoriesContainer.hidden,
    #productsContainer.hidden {
      display: none;
    }
  </style>

</head>
<body>
<div class="content-wrapper">
  <div th:replace="~{fragments/header :: header}"></div>

  <div class="container">
    <h1 class="text-center my-5">Про нас</h1>
    <div class="row mb-3">
      <div class="col-md-6">
        <p>"М-Фурнітура" - ваш надійний партнер у світі меблевої фурнітури. Ми пропонуємо якісні рішення для
          професіоналів та домашніх майстрів.</p>
      </div>
      <div class="col-md-6">
        <p>Широкий асортимент, конкурентні ціни та індивідуальний підхід до кожного клієнта - наші головні переваги.</p>
      </div>
    </div>

    <h2 class="text-center mb-4">Категорії товарів</h2>
    <div class="text-center mb-4">
      <div th:each="category : ${categories}" class="main-category-box" th:attr="data-category=${category}"
           onclick="selectCategory(this.getAttribute('data-category'))">
        <h5 th:text="${category}"></h5>
      </div>
    </div>

    <div id="carouselExample" class="carousel slide mb-5" data-bs-ride="carousel">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="/promo1.jpg" class="d-block w-100" alt="Акція 1">
        </div>
        <div class="carousel-item">
          <img src="/promo2.jpg" class="d-block w-100" alt="Акція 2">
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>

    <div id="subcategoriesContainer" class="hidden mt-4 text-center"></div>

    <div id="productsContainer" class="hidden mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 id="currentSubcategory" class="mb-0"></h3>
        <button class="btn btn-outline-secondary" onclick="goBackToSubcategories()">
          <i class="fas fa-arrow-left"></i> Назад до підкатегорій
        </button>
      </div>
      <div class="products-container" id="productsList"></div>
    </div>

  </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<div id="cart-notification" class="cart-notification">
  <i class="fas fa-shopping-cart"></i> Товар додано до кошика
</div>
<script>
  function selectCategory(category) {
    // 1. Сховати непотрібні блоки
    document.getElementById('carouselExample').classList.add('hidden');
    document.getElementById('productsContainer').classList.add('hidden');

    // 2. Підготувати контейнер для субкатегорій і показати його
    const subcatContainer = document.getElementById('subcategoriesContainer');
    subcatContainer.innerHTML = '';
    subcatContainer.classList.remove('hidden');

    // 3. Змінити підсвічування в меню
    document.querySelectorAll('.main-category-box').forEach(box => {
      box.classList.toggle('active', box.dataset.category === category);
    });

    // 4. Отримати субкатегорії
    fetch(`/get-subcategories/${encodeURIComponent(category)}`)
            .then(res => {
              if (!res.ok) throw new Error('Не вдалося завантажити субкатегорії');
              return res.json();
            })
            .then(subcategories => {
              if (!Array.isArray(subcategories) || subcategories.length === 0) {
                // Якщо субкатегорій немає — одразу показати товари самої категорії
                return loadProducts(category, '');
              }

              // Інакше — побудувати список кнопок для кожної субкатегорії
              subcategories.forEach(rawSub => {
                const cleanSub = String(rawSub).replace(/[\r\n]+/g, ' ').trim();

                const box = document.createElement('div');
                box.className = 'subcategory-box';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'subcategory-btn';
                btn.textContent = cleanSub;
                btn.addEventListener('click', () => {
                  loadProducts(category, cleanSub);
                });

                box.appendChild(btn);
                subcatContainer.appendChild(box);
              });
            })
            .catch(err => {
              console.error(err);
              alert('Сталася помилка при завантаженні субкатегорій');
            });
  }


  function loadProducts(category, subcategory) {
    // 1. Очищуємо subcategory від нових рядків та зайвих пробілів
    subcategory = String(subcategory)
            .replace(/[\r\n]+/g, ' ')
            .trim();

    // 2. Кодуємо обидва параметри для URL
    const encodedCategory = encodeURIComponent(category);
    const encodedSubcategory = encodeURIComponent(subcategory);

    // 3. Виконуємо запит
    fetch(`/api/products/${encodedCategory}/${encodedSubcategory}`)
            .then(response => {
              if (!response.ok) throw new Error('Помилка мережі');
              return response.json();
            })
            .then(products => {
              const productsList = document.getElementById('productsList');
              productsList.innerHTML = '';

              products.forEach(product => {
                const imageUrl = product.imageUrl
                        ? `/${product.imageUrl}`
                        : '/no-image.png';
                const escapedName = product.name.replace(/"/g, '&quot;');
                const productHtml = `
          <div class="product-item">
            <div class="card h-100">
              <a href="/product/${product.id}">
                <div style="
                  min-height: 200px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  overflow: hidden;">
                  <img src="${imageUrl}"
                       class="card-img-top product-image"
                       alt="${escapedName}"
                       style="object-fit: cover; width: 100%; height: auto;"
                       onerror="this.onerror=null; this.src='/no-image.png'">
                </div>
              </a>
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${product.name}</h5>
                <p class="card-text">${product.price} грн</p>
                <button class="btn btn-primary mt-auto"
                        onclick="addToCart(${product.id})">
                  <i class="fas fa-shopping-cart"></i> Додати в кошик
                </button>
              </div>
            </div>
          </div>
        `;
                productsList.innerHTML += productHtml;
              });

              // Показуємо/ховаємо відповідні блоки
              document.getElementById('subcategoriesContainer')
                      .classList.add('hidden');
              document.getElementById('productsContainer')
                      .classList.remove('hidden');
              document.getElementById('currentSubcategory')
                      .textContent = subcategory;
            })
            .catch(error => {
              console.error('Помилка:', error);
              alert('Не вдалося завантажити товари');
            });
  }


  function goBackToSubcategories() {
    document.getElementById('productsContainer').classList.add('hidden');
    document.getElementById('subcategoriesContainer').classList.remove('hidden');
  }


  function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const searchResultsList = document.getElementById('searchResultsList');

    if (searchTerm === '') {
      hideSearchResults();
      return;
    }

    const productItems = document.querySelectorAll('.product-item');
    let foundResults = false;

    searchResultsList.innerHTML = '';

    productItems.forEach(item => {
      const productName = item.querySelector('.product-name').textContent.toLowerCase();
      const productLink = item.querySelector('a').getAttribute('href');
      const productImage = item.querySelector('img').getAttribute('src');
      const productPrice = item.querySelector('p').textContent;

      if (productName.includes(searchTerm)) {
        foundResults = true;
        const resultItem = document.createElement('a');
        resultItem.href = productLink;
        resultItem.className = 'list-group-item list-group-item-action search-result-item';

        const highlightedName = highlightSearchTerm(productName, searchTerm);

        resultItem.innerHTML = `
                    <img src="${productImage}" onerror="this.src='/no-image.png'">
                    <div class="search-result-info">
                        <div>${highlightedName}</div>
                        <small class="text-muted">${productPrice}</small>
                    </div>
                `;

        searchResultsList.appendChild(resultItem);
      }
    });

    if (!foundResults) {
      searchResultsList.innerHTML = '<div class="no-results">Нічого не знайдено</div>';
    }

    showSearchResults();
  }

  function highlightSearchTerm(text, term) {
    const regex = new RegExp(term, 'gi');
    return text.replace(regex, match => `<span class="search-highlight">${match}</span>`);
  }

  function showSearchResults() {
    const dropdown = document.getElementById('searchResultsDropdown');
    dropdown.classList.add('show');
    dropdown.style.display = 'block';
  }

  function hideSearchResults() {
    const dropdown = document.getElementById('searchResultsDropdown');
    dropdown.classList.remove('show');
    dropdown.style.display = 'none';
  }

  function getCsrfToken() {
    return document.cookie
            .split('; ')
            .find(row => row.startsWith('XSRF-TOKEN='))
            ?.split('=')[1];
  }

  function addToCart(productId) {
    fetch(`/api/cart/add?productId=${productId}`, {
      method: 'POST',
      headers: {
        'X-XSRF-TOKEN': getCsrfToken()
      },
      credentials: 'include'
    })
            .then(response => response.json())
            .then(data => {
              showCartNotification(data.message);
              updateCartDropdown();
            })
            .catch(error => console.error('Помилка:', error));
  }

  function removeFromCart(productId) {
    fetch(`/api/cart/remove?productId=${productId}`, {
      method: 'DELETE'
    })
            .then(response => {
              if (!response.ok) throw new Error(response.statusText);
              return response.json();
            })
            .then(data => {
              showCartNotification(data.message);
              updateCartDropdown();
            })
            .catch(error => {
              console.error('Помилка:', error);
              alert('Помилка при видаленні товару з кошика');
            });
  }

  function increaseQuantity(productId) {
    fetch(`/api/cart/increase?productId=${productId}`, {
      method: 'POST'
    })
            .then(response => {
              if (!response.ok) throw new Error(response.statusText);
              return response.json();
            })
            .then(data => {
              updateCartDropdown();
            })
            .catch(error => {
              console.error('Помилка:', error);
              alert('Помилка при збільшенні кількості');
            });
  }

  function decreaseQuantity(productId) {
    fetch(`/api/cart/decrease?productId=${productId}`, {
      method: 'POST'
    })
            .then(response => {
              if (!response.ok) throw new Error(response.statusText);
              return response.json();
            })
            .then(data => {
              updateCartDropdown();
            })
            .catch(error => {
              console.error('Помилка:', error);
              alert('Помилка при зменшенні кількості');
            });
  }

  function updateCartDropdown() {
    fetch('/api/cart/items')
            .then(response => {
              if (!response.ok) throw new Error(response.statusText);
              return response.json();
            })
            .then(data => {
              const cartItemsContainer = document.getElementById('cartItemsContainer');
              const cartCount = document.getElementById('cartCount');
              const cartTotal = document.getElementById('cartTotal');

              if (data.items && data.items.length > 0) {
                const groupedItems = data.items.reduce((acc, item) => {
                  if (!acc[item.id]) {
                    acc[item.id] = {
                      ...item,
                      quantity: 0,
                      imageUrl: item.imageUrl || '/no-image.png'
                    };
                  }
                  acc[item.id].quantity++;
                  return acc;
                }, {});

                cartItemsContainer.innerHTML = `
                        <h6 class="mb-3">Товари у кошику</h6>
                        ${Object.values(groupedItems).map(item => `
                            <div class="cart-item">
                                <img src="${item.imageUrl}"
                                     onerror="this.src='/no-image.png'"
                                     class="cart-item-img">
                                <div class="cart-item-info">
                                    <div class="cart-item-name">${item.name}</div>
                                    <div class="cart-item-price">${item.price} грн/шт</div>
                                    <div class="cart-item-controls">
                                        <button class="quantity-btn"
                                                onclick="decreaseQuantity(${item.id})">-</button>
                                        <span class="quantity-value">${item.quantity}</span>
                                        <button class="quantity-btn"
                                                onclick="increaseQuantity(${item.id})">+</button>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">${(item.price * item.quantity).toFixed(2)} грн</div>
                                    <div class="remove-item"
                                         onclick="removeFromCart(${item.id})">
                                        Видалити
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                cartCount.textContent = data.items.length;
                cartCount.style.display = 'block';
                cartTotal.textContent = data.total.toFixed(2) + ' грн';
              } else {
                cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>Кошик порожній</p>
                        </div>
                    `;
                cartCount.style.display = 'none';
                cartTotal.textContent = '0 грн';
              }
            })
            .catch(error => {
              console.error('Помилка:', error);
              alert('Помилка при оновленні кошика');
            });
  }

  function showCartNotification(message) {
    const notification = document.getElementById('cart-notification');
    notification.innerHTML = `<i class="fas fa-shopping-cart"></i> ${message}`;
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 2000);
  }

  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');

    let searchTimeout;

    searchInput.addEventListener('input', function () {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(searchProducts, 300);
    });

    searchButton.addEventListener('click', searchProducts);

    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchProducts();
      }
    });

    document.addEventListener('click', function (e) {
      if (!e.target.closest('.search-container') && !e.target.closest('#searchResultsDropdown')) {
        hideSearchResults();
      }
    });

  });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>